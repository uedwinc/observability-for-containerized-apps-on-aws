# End-to-end visibility of containerized applications using AWS App Mesh

AWS App Mesh is a networking service that enables seamless communication between services deployed across different computing infrastructures.

Modern applications are typically built using multiple services deployed across various computing infrastructures, including Amazon EC2, Amazon EKS, and AWS Fargate. As the number of services grows, it becomes challenging to identify the source of errors, reroute traffic after failures, and safely deploy code changes.

AWS App Mesh simplifies service deployment by providing consistent visibility and network traffic controls for services deployed across different computing infrastructures. With App Mesh, there is no need to modify your application code to alter the way monitoring data is collected or traffic is routed between services. Instead, App Mesh configures each service to export monitoring data and ensures that communication control logic is standardized across your application. This enables you to quickly identify the source of errors and reroute network traffic automatically when there are failures or code changes.

You can use App Mesh to run your application at scale with various computing infrastructures, including AWS Fargate, Amazon EC2, Amazon ECS, Amazon EKS, and Kubernetes running on AWS. App Mesh leverages the open source Envoy proxy, which makes it compatible with a wide range of AWS partners and open source tools.

## Add monitoring and logging capabilities

One of the main benefits of implementing App Mesh is the ability to have visibility around your microservices and their communications.

AWS App Mesh allows you to integrate the logs generated by the Envoy proxies running in your infrastructure with Amazon CloudWatch.

The first step is to activate Container Insights in your cluster (EKS or ECS)

Enable CloudWatch for the container and the Envoy sidecar following the instructions at https://docs.aws.amazon.com/AmazonECS/latest/userguide/using_awslogs.html.

After a few minutes, you should see the logging details provided by the envoy sidecar under Cloudwatch log groups for envoy

## Add end-to-end tracing capabilities

The integration of AWS X-Ray and AWS App Mesh allows for the effective management of Envoy proxies utilized by microservices. Envoy, which is available in App Mesh, can be customized to transmit trace data to the X-Ray daemon, which operates in a container located in the same pod or task. To activate the integration of X-Ray with App Mesh Envoy proxies, see the following details.

1. An envoy task definition for ECS should have the following properties:

```json
{
  "name": "envoy",
  "image": "840364872350.dkr.ecr.us-west-2.amazonaws.com/aws-appmesh-envoy:v1.15.1.0-prod",
  "essential": true,
  "environment": [
    {
      "name": "APPMESH_VIRTUAL_NODE_NAME",
      "value": "mesh/myMesh/virtualNode/myNode"
    },
    {
      "name": "ENABLE_ENVOY_XRAY_TRACING",
      "value": "1"
    }
  ],
  "healthCheck": {
    "command": [
      "CMD-SHELL",
      "curl -s http://localhost:9901/server_info | cut -d' ' -f3 | grep -q live"
    ],
    "startPeriod": 10,
    "interval": 5,
    "timeout": 2,
    "retries": 3
  }
}
```

In the preceding example, the App Mesh envoy image is set together with the `ENABLE_ENVOY_XRAY_TRACING` environment variable to `1`. That is all that is necessary to activate the X-Ray integration. 

2. Now, for EKS, it is slightly different. Assuming you use Helm as the tool to deploy the App Mesh Envoy, the deployment command looks like this:

```sh
helm upgrade -i appmesh-controller eks/appmesh-controller \
--namespace appmesh-system \
--set region=${AWS_REGION} \
--set serviceAccount.create=false \
--set serviceAccount.name=appmesh-controller \
--set tracing.enabled=true \
--set tracing.provider=x-ray
```
